# Detailed In-Place Implementation Plan

## Overview

This plan implements the **Light Snakepit + Heavy Bridge** architecture by systematically transforming the existing codebase.

**Strategy**: Purify the existing `snakepit` infrastructure first, then build the ML platform (`snakepit_grpc_bridge`) on top of that proven, generic foundation, and finally refactor the consumer (`dspex`).

---

## Phase 1: Purify Snakepit & Bootstrap Bridge (Week 1)

### Day 1: Audit and Isolate Domain Logic
**Objective:** Identify and isolate all ML/DSPy/gRPC domain logic within the `snakepit` application.

*   **Action (Audit):** Systematically audit all Elixir and Python files in the `snakepit` project. Create a manifest (`purification_manifest.md`) listing every file and code block that contains domain-specific logic (e.g., mentions of "dspy", "variable", "tool", hardcoded Python paths, gRPC specifics).
*   **Action (Isolate):** Create a temporary directory `snakepit_domain_logic_to_move`. Move all identified files and code snippets into this directory. This visually separates what needs to be purified.

### Day 2: Execute Purification and Prove Generality
**Objective:** Finalize the purification of `snakepit` and prove its generic nature with a mock adapter test.

*   **Action (Purify):**
    *   Remove all gRPC-related modules and dependencies from `snakepit/mix.exs`. The choice of communication protocol belongs to the adapter.
    *   Ensure the `Snakepit.Adapter` behavior is the only remaining contract between `snakepit`'s core and the outside world.
*   **Action (Prove):**
    *   Create `test/support/mock_adapter.ex` and `test/infrastructure_purity_test.exs` as detailed in the `prompts`.
    *   **Validation:** Run `mix test`. The purity test suite must pass, confirming that the `snakepit` pool and supervision tree function correctly with a completely non-ML, non-Python adapter. **Do not proceed until this works.**

### Day 3: Bootstrap SnakepitGRPCBridge
**Objective:** Create the new `snakepit_grpc_bridge` package and move the isolated domain logic into its proper new home.

*   **Action:** Follow `prompts/01_bootstrap_snakepit_grpc_bridge.md` to create the new Mix project and its directory structure.
*   **Action:** Move all code from the `snakepit_domain_logic_to_move` directory into the appropriate locations within the new `snakepit_grpc_bridge` project.
*   **Validation:** Both `snakepit` and `snakepit_grpc_bridge` should compile successfully, with the latter depending on the former via a `path:` dependency.

---

## Phase 2: Build the ML Platform (Weeks 2-3)

### Day 4-6: Implement Python Bridge and Adapter
**Objective:** Implement the core communication layer connecting `snakepit` infrastructure to the Python runtime.

*   **Action:** Follow the detailed instructions in `prompts/05_implement_python_bridge_CORRECTED.md`.
    *   Implement `SnakepitGRPCBridge.Python.Process` to manage the `Port`.
    *   Implement the `SnakepitGRPCBridge.Adapter` callbacks to correctly start and communicate with the `Python.Process` worker.
    *   Implement the Python-side `worker.py` script.
*   **Validation:** A call to `Snakepit.execute("ping", %{})` successfully routes through your adapter to the Python process and back.

### Day 7-9: Implement the Variables System
**Objective:** Build the complete, session-aware variable management system.

*   **Action:** Follow the detailed instructions in `prompts/02_implement_variables_system.md`.
    *   Implement `SnakepitGRPCBridge.Variables.Manager`.
    *   Implement `SnakepitGRPCBridge.Variables.Types` and the ML-specific types.
    *   Update `SnakepitGRPCBridge.Adapter` to route variable-related commands.
*   **Validation:** The `Variables.Manager` unit tests pass. Calls to `Snakepit.execute("create_variable", ...)` work end-to-end through the Python bridge.

### Day 10-12: Implement the Tools System
**Objective:** Build the bidirectional tool registry and execution system.

*   **Action:** Follow the detailed instructions in `prompts/03_implement_tools_system.md`.
    *   Implement `SnakepitGRPCBridge.Tools.Registry` and `Executor`.
    *   Implement parameter validation and serialization.
    *   Update the `Adapter` to route tool commands.
*   **Validation:** Elixir and Python functions can be registered as tools and called from the other language.

### Day 13-14: Implement the DSPy System
**Objective:** Build the high-level DSPy integration layer.

*   **Action:** Follow the detailed instructions in `prompts/04_implement_dspy_system.md`.
    *   Implement `SnakepitGRPCBridge.DSPy.Integration`.
    *   Update the `Adapter` to route DSPy commands.
*   **Validation:** High-level DSPy operations like `enhanced_predict` work, correctly leveraging the underlying variable and tool systems.

---

## Phase 3: Simplify DSPex Consumer Layer (Week 4)

### Day 15-17: Refactor DSPex
**Objective:** Transform `DSPex` into a pure orchestration layer.

*   **Action:** Update `dspex/mix.exs` to depend on `snakepit_grpc_bridge`.
*   **Action:** Remove all implementation logic (variables, tools, python bridge) from `dspex`.
*   **Action:** Rewrite the `DSPex` main module and the `defdsyp` macro to be thin wrappers that call the clean APIs in `SnakepitGRPCBridge.API.*`.

### Day 18: Full-Stack Integration Testing
**Objective:** Ensure the complete three-layer system works flawlessly together.

*   **Action:** Create a comprehensive integration test suite in `dspex` that exercises user stories starting from the top layer down through the entire stack.
*   **Validation:** All existing functionality is confirmed to work through the new architecture.

---

## Phase 4: Polish and Release (Week 5)

### Day 19-21: Performance Testing and Documentation
**Objective:** Benchmark the new system and update all documentation.

*   **Action:** Perform performance and benchmark testing to identify any regressions or new bottlenecks. Address as needed.
*   **Action:** Update all `README.md` files and module documentation to reflect the new, clean architecture. Create a migration guide for users.

### Day 22-23: Final Validation and Release
**Objective:** Prepare and publish the packages.

*   **Action:** Finalize version numbers and package metadata.
*   **Action:** Publish packages to Hex in the correct dependency order: `snakepit`, then `snakepit_grpc_bridge`, then `dspex`.
